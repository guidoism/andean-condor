# cd 2023-01-18.andean-condor
# cd ergogen
# npm install
# node src/cli.js ../andean-condor/andean-condor.yaml -o ../andean-condor/ergogen-output
units:
  p: 2.54
points:
  zones:
    matrix:
      anchor:
        rotate: 5
        shift: [100, -100]
      key:
        tags: [switchcore]
      columns:
        farpinky.key:
          col_net: col1
        pinky.key:
          col_net: col2
        ring.key:
          stagger: 12
          col_net: col3
        middle.key:
          stagger: 5
          col_net: col4
        index.key:
          stagger: -6
          col_net: col5
        inner.key:
          stagger: -2
          col_net: col6
      rows:
        bottom:
          row_net: row3
          mirror.row_net: row3r
        home:
          row_net: row2
          mirror.row_net: row2r
        top:
          row_net: row1
          mirror.row_net: row1r
    thumbfan:
      key:
        tags: [thumbfan]
      anchor:
        ref: matrix_middle_bottom
        shift: [5.5, -25]
      columns:
        tucky.rows.top: $unset
        near.rows.top: $unset
        tucky.key:
          splay: -5
          col_net: col1
        near.key:
          splay: -15
          origin: [-9.5, -9.5]
          col_net: col2
        home:
          key:
            splay: -15
            origin: [-9.5, -9.5]
          rows:
            thumb.col_net: col3
            top.col_net: col6
        far:
          key:
            splay: -15
            origin: [-9.5, -9.5]
          rows:
            thumb.col_net: col4
            top.col_net: col5
      rows:
        thumb:
          row_net: row4
          mirror.row_net: row4r
        top:
          row_net: row4
          mirror.row_net: row4r
  rotate: -20
  mirror:
    ref: thumbfan_far_top
    distance: 25
    # row_net: P6

    
outlines:
  outline:
    main:
      what: rectangle
      where: /.*matrix.*|thumbfan|mirror_thumbfan.*/
      size: 20
      fillet: 2
    inbetweenstuff:
      what: polygon
      points:
        - ref: matrix_inner_top
          shift: [$default_width/2,$default_height/2]
        - ref: thumbfan_tucky_thumb
          shift: [$default_width/2,$default_height/2]
        - ref: thumbfan_tucky_thumb
          shift: [$default_width/2,-$default_height/2]
        - ref: thumbfan_near_thumb
          shift: [0,-$default_height/2]
        - ref: thumbfan_home_thumb
          shift: [0,-$default_height/2]
        - ref: thumbfan_far_thumb
          shift: [$default_width/2,-$default_height/2]
        - ref: thumbfan_far_top
          shift: [$default_width/2,$default_height/2]
        - ref: mirror_thumbfan_far_thumb
          shift: [$default_width/2,-$default_height/2]
        - ref: mirror_thumbfan_home_thumb
          shift: [0,-$default_height/2]
        - ref: mirror_thumbfan_near_thumb
          shift: [0,-$default_height/2]
        - ref: mirror_thumbfan_tucky_thumb
          shift: [$default_width/2,-$default_height/2]
        - ref: mirror_thumbfan_tucky_thumb
          shift: [$default_width/2,$default_height/2]
        - ref: mirror_matrix_inner_top
          shift: [$default_width/2,$default_height/2]
  plate:
    - what: outline
      name: outline
pcbs:
  andean-condor:
    outlines:
      main:
        outline: plate
    footprints:
      mx:
        what: mx
        where: [switchcore, thumbfan]
        params:
          from: "{{colrow}}"
          to: "{{col_net}}"
          keycaps: true
      diodecoreleftupper:
        what: diode
        where: /^matrix_.*_[top|home]/
        adjust:
          rotate: 90
          shift: [8.7, 0]
        params:
          from: "{{colrow}}"
          to: "{{row_net}}"
      diodecoreleftlower:
        what: diode
        where: /^matrix_.*_bottom/
        adjust:
          rotate: -90
          shift: [8.7, 7]
        params:
          from: "{{colrow}}"
          to: "{{row_net}}"
      diodecorerightupper:
        what: diode
        where: /^mirror_matrix_.*_[top|home]/
        adjust:
          rotate: -90
          shift: [8.7, 0]
        params:
          from: "{{colrow}}"
          to: "{{row_net}}"
      diodecorerightlower:
        what: diode
        where: /^mirror_matrix_.*_bottom/
        adjust:
          rotate: 90
          shift: [8.7, 7]
        params:
          from: "{{colrow}}"
          to: "{{row_net}}"
      diodethumbsleft:
        what: diode
        where: /^thumbfan_.*/
        adjust:
          rotate: 180
          shift: [5, 8.7]
        params:
          from: "{{colrow}}"
          to: "{{row_net}}"
      diodethumbsright:
        what: diode
        where: /^mirror_thumbfan_.*/
        adjust:
          rotate: 0
          shift: [5, 8.7]
        params:
          from: "{{colrow}}"
          to: "{{row_net}}"
      nicenano:
        what: nicenano
        where:
          ref.aggregate.parts: [matrix_inner_top, mirror_matrix_inner_top]
          rotate: -90
          shift: [0, -12]
        params:
          orientation: down # NOTE: up doesn't seem to work
          RAW: RAW
          GND1: GND
          RST: RST
          VCC: VCC
          P21: row1r
          P20: row2r
          P19: row1
          P18: row2
          P15: col1
          P14: col6
          P16: row3r
          P10: row4r 
          P1: CS
          P0: extra1
          GND2: GND
          GND3: GND
          P2: SDA
          P3: SCL
          P4: col4
          P5: col5
          P6: col3
          P7: col2
          P8: row3
          P9: row4
# This is what the pinout I am expected looking down at the Nice!Nano
#       1   .
# CS    0   .
#       .   .
#       .   .
# SCK   2   21 row1r
# MOSI  3   20 row2r
# col4  4   19 row1
# col5  5   18 row2
# col3  6   15 col1
# col2  7   14 col6
# row3  8   16 row3r
# row4  9   10 row4r
      niceview:
        what: niceview
        where: 
          ref.aggregate.parts: [matrix_inner_top, mirror_matrix_inner_top]
          rotate: -90
          shift: [0, -10]
        adjust:
          shift: [20.5, 0]
          rotate: 180
        params:
          outline: true
          side: 'F'
          SDA: SDA
          SCL: SCL
          VCC: VCC
          GND: GND
          CS: CS
      slider:
        what: slider
        where: 
          ref.aggregate.parts: [matrix_inner_top, mirror_matrix_inner_top]
          rotate: 0
          shift: [-14, 4]
        params:
          side: F
          from: switch_from
          to: RAW
      battery:
        what: battery
        where:
          ref.aggregate.parts: [matrix_inner_top, mirror_matrix_inner_top]
          shift: [0, -14p]
          rotate: 90
        params:
          RAW: switch_from
      rotary:
        what: rotary
        where:
          ref.aggregate.parts: [matrix_inner_top, mirror_matrix_inner_top]
          shift: [0, -21p]
          rotate: -90
        params:
          from: GND
          to: GND
          A: SDA
          B: GND
          C: CS
      # Four Pin Reset Button
      reset:
        what: button
        params:
          from: GND
          to: RST
        where:
          ref.aggregate.parts: [matrix_index_top, mirror_matrix_index_top]
          shift: [0, -18p]
          rotate: -90
      left_header:
        what: header
        params:
          pins: [GND, VCC, A, B, C, D, E, F, H, I, J, K, L, M]
        where:
          ref.aggregate.parts: [matrix_index_top, mirror_matrix_index_top]
          shift: [-7p, -6p]
      right_header:
        what: header
        params:
          pins: [GND, VCC, A, B, C, D, E, F, H, I, J, K, L, M]
        where:
          ref.aggregate.parts: [matrix_index_top, mirror_matrix_index_top]
          shift: [7p, -6p]
#      columnbus1:
#        what: via
#        params.net: col1
#        where: /^matrix_.*_home/
#        adjust.shift: [-2.5, -6]
#      columnbus2:
#        what: via
#        params.net: col2
#        where: /^matrix_.*_home/
#        adjust.shift: [-2, -7]
#      columnbus3:
#        what: via
#        params.net: col3
#        where: /^matrix_.*_home/
#        adjust.shift: [-1.5, -8]
#      columnbus4:
#        what: via
#        params.net: col4
#        where: /^matrix_.*_home/
#        adjust.shift: [-1, -9]
#      columnbus5:
#        what: via
#        params.net: col5
#        where: /^matrix_.*_home/
#        adjust.shift: [-0.5, -10]
#      columnbus6:
#        what: via
#        params.net: col6
#        where: /^matrix_.*_home/
#        adjust.shift: [0, -11]
        
